<!DOCTYPE html>
<html lang="en">	<!-- <html lang="zh-CN"> -->
<head>
	<!--This line will work only if your website is hosted under a graphics.cs.cmu.edu or imaging.cs.cmu.edu domain.-->
	<!-- <meta charset="utf-8" /> -->
	<script src="https://kit.fontawesome.com/3058f11e8e.js" crossorigin="anonymous"></script>
	<link rel="icon" href="index_files/favicon.png" type="image/png">
	<meta name="description" content="Your name">
	<meta name="keywords" content="Your keywords">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="index_files/style.css" rel="stylesheet" type="text/css">
	<title>Access Count</title>
	<script src="https://accounts.google.com/gsi/client" async defer></script>
	<script src="https://apis.google.com/js/api.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
	<header>
		<h1>Project 1: Access Count</h1>
	</header>
	<main>
		<section id="other">
			<h2>Other content</h2>
			<p>Updated: August 18, 2025.</p>
		</section>

		<section id="count">
			<h2>Count</h2>
			<p>Page views(PV): &nbsp;&nbsp;<a id="pagePV">--</a></p>
			<p>Site visits(SV): &nbsp;&nbsp;<a id="sitePV">--</a></p>
			<h2>GA4 Analytics 可视化</h2>
			<div id="g_id_signin"></div>
			<canvas id="chart" width="600" height="300"></canvas>
			<p style="font-size:14px;color:gray">PS: Using Google Analytics counting. Data powered by Google Analytics 4</p>
		</section>
	</main>

	<footer>
		<hr>
		<ul id="personal">
			<li><a href="index.html"><i class="fa fa-envelope fa-sm fa-fw"></i>&nbsp;MainPage</a></li>
			<li><a href="project1.html"><i class="fa fa-brands fa-orcid fa-sm fa-fw"></i>&nbsp;Project1</a></li>
		</ul>
	</footer>

	<script>
		// ⚠️ 替换为你在 GCP 上创建的 OAuth Client ID
		const CLIENT_ID = "691447500712-rrl8pe6n26nbgn0nq8bblt0gqjndieu4.apps.googleusercontent.com";
		const SCOPES = "https://www.googleapis.com/auth/analytics.readonly";
		// ⚠️ 替换为你的 GA4 property ID (格式类似：123456789)
		const PROPERTY_ID = "365366473";
		let accessToken;
		// Step 1: GIS 初始化
		function gisInit() {
			google.accounts.oauth2.initTokenClient({
				client_id: CLIENT_ID,
				scope: SCOPES,
				callback: (response) => {
				accessToken = response.access_token;
				console.log("Access Token:", accessToken);
				queryGAData();
				}
			}).requestAccessToken();
		}
		// Step 2: 按钮登录（Google 提供的登录按钮）
		window.onload = function() {
			google.accounts.id.renderButton(
				document.getElementById("g_id_signin"),
				{ theme: "outline", size: "large" }
			);
			document.getElementById("g_id_signin").addEventListener("click", gisInit);
		}
		// Step 3: 调用 GA4 Data API
		async function queryGAData() {
			const url = `https://analyticsdata.googleapis.com/v1beta/properties/${PROPERTY_ID}:runReport`;
			const body = {
				dateRanges: [{ startDate: "7daysAgo", endDate: "today" }],
				metrics: [{ name: "activeUsers" }],
				dimensions: [{ name: "date" }]
			};
			const response = await fetch(url, {
				method: "POST",
				headers: {
				"Authorization": `Bearer ${accessToken}`,
				"Content-Type": "application/json"
				},
				body: JSON.stringify(body)
			});
			const data = await response.json();
			console.log("GA4 数据:", data);
			renderChart(data);
		}
		// Step 4: 用 Chart.js 可视化
		function renderChart(data) {
			const labels = data.rows.map(row => row.dimensionValues[0].value);
			const values = data.rows.map(row => row.metricValues[0].value);
			new Chart(document.getElementById("chart"), {
				type: "line",
				data: {
				labels: labels,
				datasets: [{
					label: "活跃用户数",
					data: values,
					borderColor: "blue",
					fill: false
				}]
				}
			});
		}
	</script>
</body>
</html>

