<!DOCTYPE html>
<html lang="en">	<!-- <html lang="zh-CN"> -->
<head>
	<!--This line will work only if your website is hosted under a graphics.cs.cmu.edu or imaging.cs.cmu.edu domain.-->
	<!-- <meta charset="utf-8" /> -->
	<script src="https://kit.fontawesome.com/3058f11e8e.js" crossorigin="anonymous"></script>
	<link rel="icon" href="index_files/favicon.png" type="image/png">
	<meta name="description" content="GA4 Analytics Visualization">
	<meta name="keywords" content="Access Count, GA4">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="index_files/style.css" rel="stylesheet" type="text/css">
	<title>Access Count</title>
	<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
	<header>
		<h1>Project 1: Access Count</h1>
	</header>
	<main>
		<section id="other">
			<h2>Other content</h2>
			<p>Updated: August 18, 2025.</p>
		</section>

		<section id="count">
			<h2>Count</h2>
			<button id="authorize_button">Authorize with Google</button>
			<p>Page views (PV): &nbsp;&nbsp;<span id="pagePV">--</span></p>
			<p>Site visits (SV): &nbsp;&nbsp;<span id="sitePV">--</span></p>
			<p style="font-size:14px;color:gray">PS: Using Google Analytics counting. Data powered by Google Analytics 4 API.</p>
		</section>
	</main>

	<footer>
		<hr>
		<ul id="personal">
			<li><a href="index.html"><i class="fa fa-envelope fa-sm fa-fw"></i>&nbsp;MainPage</a></li>
			<li><a href="project1.html"><i class="fa fa-brands fa-orcid fa-sm fa-fw"></i>&nbsp;Project1</a></li>
		</ul>
	</footer>

	<script>
		// ⚠️ 替换为你在 GCP 上创建的 OAuth Client ID
		const CLIENT_ID = "691447500712-rrl8pe6n26nbgn0nq8bblt0gqjndieu4.apps.googleusercontent.com";
		const SCOPES = "https://www.googleapis.com/auth/analytics.readonly";
		// ⚠️ 替换为你的 GA4 property ID (格式类似：123456789)
		const PROPERTY_ID = "501354848";
		let tokenClient;
		let gapiInited = false;
		let gisInited = false;
		// 1. 加载 Google API
		function gapiLoaded() {
			gapi.load('client', initializeGapiClient);
		}
		async function initializeGapiClient() {
			await gapi.client.init({
				discoveryDocs: ["https://analyticsdata.googleapis.com/$discovery/rest?version=v1"],
			});
			gapiInited = true;
		}
		function gisLoaded() {
			tokenClient = google.accounts.oauth2.initTokenClient({
				client_id: CLIENT_ID,
				scope: SCOPES,
				callback: handleAuthResult, // 授权成功后的回调
			});
			gisInited = true;
			document.getElementById("authorize_button").disabled = false;
		}
		// 2. 授权按钮点击
		document.getElementById("authorize_button").onclick = () => {
			if (!gisInited || !gapiInited) {
				alert("Google API 未初始化完成");
				return;
			}
			tokenClient.requestAccessToken();
		};
		// 3. 处理授权结果
		function handleAuthResult(tokenResponse) {
			if (tokenResponse && tokenResponse.access_token) {
				queryGA4Data(tokenResponse.access_token);
			} else {
				console.error("授权失败", tokenResponse);
			}
		}
		// 4. 调用 GA4 Data API
		async function queryGA4Data() {
			try {
				const response = await gapi.client.analyticsdata.properties.runReport({
					property: `properties/${PROPERTY_ID}`,
					requestBody: {
						dimensions: [{ name: "date" }],
						metrics: [
							{ name: "screenPageViews" }, // PV
							{ name: "totalUsers" }       // SV
						],
						dateRanges: [{ startDate: "7daysAgo", endDate: "today" }]
					}
				});
				if (response.result && response.result.rows) {
					let totalPV = 0;
					let totalSV = 0;
					response.result.rows.forEach(row => {
						totalPV += parseInt(row.metricValues[0].value);
						totalSV += parseInt(row.metricValues[1].value);
					});
					document.getElementById("pagePV").innerText = totalPV;
					document.getElementById("sitePV").innerText = totalSV;
				} else {
					console.warn("没有返回数据", response);
				}
			} catch (err) {
				console.error("API 调用失败", err);
			}
		}
	</script>

	<!-- 引入 gapi -->
	<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
	<script async defer onload="gisLoaded()"></script>
</body>
</html>

